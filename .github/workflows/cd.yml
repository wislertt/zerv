name: cd

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: write
    issues: write
    pull-requests: write

jobs:
    # ====================================================
    # Versioning and Release
    # ====================================================
    semantic-release:
        name: semantic-release
        uses: ./.github/workflows/shared-semantic-release.yml
        with:
            allowed_workflow_dispatch_branches: '["main"]'
            fail_on_invalid_workflow_dispatch_ref: true

    zerv-versioning:
        needs: semantic-release
        if: needs.semantic-release.outputs.is_valid_semantic_release == 'true'
        uses: ./.github/workflows/shared-zerv-versioning.yml

    create-version-prefix-tags:
        needs: zerv-versioning
        uses: ./.github/workflows/shared-create-tags.yml
        with:
            tags: >-
                [
                  "${{ fromJson(needs.zerv-versioning.outputs.versions).v_semver_major }}",
                  "${{ fromJson(needs.zerv-versioning.outputs.versions).v_semver_major_minor }}"
                ]

    # ====================================================
    # Test and Lint
    # ====================================================
    test:
        uses: ./.github/workflows/test.yml
        secrets:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    pre-commit:
        uses: ./.github/workflows/pre-commit.yml

    # ====================================================
    # Deployment without environment
    # ====================================================
    release-bin:
        name: release-bin-github-${{ matrix.name }}
        runs-on: ${{ matrix.os }}
        needs: semantic-release
        if: needs.semantic-release.outputs.published == 'true'
        strategy:
            fail-fast: false
            matrix:
                include:
                    - name: linux-x64
                      os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      artifact_name: zerv
                      asset_name: zerv-linux-x86_64
                    - name: linux-arm64
                      os: ubuntu-latest
                      target: aarch64-unknown-linux-gnu
                      artifact_name: zerv
                      asset_name: zerv-linux-arm64
                    - name: macos-x64
                      os: macos-latest
                      target: x86_64-apple-darwin
                      artifact_name: zerv
                      asset_name: zerv-macos-x86_64
                    - name: macos-arm64
                      os: macos-latest
                      target: aarch64-apple-darwin
                      artifact_name: zerv
                      asset_name: zerv-macos-arm64
                    - name: windows-x64
                      os: windows-latest
                      target: x86_64-pc-windows-msvc
                      artifact_name: zerv.exe
                      asset_name: zerv-windows-x86_64.exe
                    - name: windows-arm64
                      os: windows-latest
                      target: aarch64-pc-windows-msvc
                      artifact_name: zerv.exe
                      asset_name: zerv-windows-arm64.exe

        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

            - uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # stable
              with:
                  toolchain: stable
                  targets: ${{ matrix.target }}

            - name: Install cross-compilation dependencies
              if: matrix.target == 'aarch64-unknown-linux-gnu'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gcc-aarch64-linux-gnu
                  echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

            - name: Update Cargo.toml version
              shell: bash
              run: |
                  VERSION="${{ needs.semantic-release.outputs.version }}"
                  echo "Updating version to $VERSION"
                  if [[ "$RUNNER_OS" == "macOS" ]]; then
                      sed -i '' "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
                  else
                      sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
                  fi

            - name: Build binary
              run: cargo build --release --target ${{ matrix.target }}

            - name: Upload binary to release
              uses: svenstaro/upload-release-action@6b7fa9f267e90b50a19fef07b3596790bb941741 # 2.11.3
              with:
                  repo_token: ${{ secrets.GITHUB_TOKEN }}
                  file: target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
                  asset_name: ${{ matrix.asset_name }}
                  tag: v${{ needs.semantic-release.outputs.version }}
                  overwrite: true

    release-crates:
        name: release-crates
        runs-on: ubuntu-latest
        needs: [semantic-release, release-bin]
        if: needs.semantic-release.outputs.published == 'true'
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

            - uses: dtolnay/rust-toolchain@0b1efabc08b657293548b77fb76cc02d26091c7e # stable
              with:
                  toolchain: stable

            - name: Update Cargo.toml version
              run: |
                  VERSION="${{ needs.semantic-release.outputs.version }}"
                  echo "Updating version to $VERSION"
                  sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml

            - name: Release to crates.io
              run: |
                  set -o pipefail
                  if cargo publish --token ${{ secrets.CARGO_TOKEN }} --allow-dirty 2>&1 | tee output.log; then
                      echo "Publish succeeded."
                  elif grep -q "already exists on crates.io index" output.log; then
                      echo "Version already exists, skipping publish."
                      exit 0
                  else
                      echo "Publish failed with unexpected error."
                      exit 1
                  fi
