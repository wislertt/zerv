name: test

on:
    workflow_call:
        secrets:
            SONAR_TOKEN:
                required: true
            CODECOV_TOKEN:
                required: true

env:
    # Reusable cargo cache paths - available to all jobs
    CARGO_CACHE_PATHS: |
        ~/.cargo/bin/
        ~/.cargo/registry/index/
        ~/.cargo/registry/cache/
        ~/.cargo/git/db/
        ${{ github.workspace }}/target/

jobs:
    rust:
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
        runs-on: ${{ matrix.os }}
        env:
            ZERV_TEST_NATIVE_GIT: true
            ZERV_TEST_DOCKER: ${{ matrix.os == 'ubuntu-latest' && 'true' || 'false' }}
            ZERV_FORCE_RUST_LOG_OFF: ${{ matrix.os == 'ubuntu-latest' && 'true' || 'false' }}
            PYTHON_VERSION: "3.14"
        steps:
            - name: checkout-repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
              with:
                  fetch-depth: 0

            - name: set-python-version
              run: echo "${{ matrix.python-version }}" > .python-version

            - name: setup-mise
              uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1

            - name: restore-cache-cargo
              id: restore-cache-cargo
              env:
                  CACHE_KEY_PREFIX: cargo-${{ github.workflow }}-${{ github.job }}-${{ runner.os }}
              uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
              with:
                  path: ${{ env.CARGO_CACHE_PATHS }}
                  key: ${{ env.CACHE_KEY_PREFIX }}-${{ hashFiles('**/Cargo.lock') }}-${{ github.run_id }}-${{ github.run_attempt }}
                  restore-keys: |
                      ${{ env.CACHE_KEY_PREFIX }}-${{ hashFiles('**/Cargo.lock') }}-
                      ${{ env.CACHE_KEY_PREFIX }}-

            - name: cache-venv
              env:
                  CACHE_KEY_PREFIX: venv-${{ github.workflow }}-${{ github.job }}-${{ runner.os }}-py${{ env.PYTHON_VERSION }}
                  CACHE_KEY_DEPS: ${{ hashFiles('uv.lock') }}
              uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
              with:
                  path: |
                      ~/.local/share/uv
                      ~/.cache/uv
                      ${{ github.workspace }}/.venv
                  key: ${{ env.CACHE_KEY_PREFIX }}-${{ env.CACHE_KEY_DEPS }}-${{ github.run_id }}-${{ github.run_attempt }}
                  restore-keys: |
                      ${{ env.CACHE_KEY_PREFIX }}-${{ env.CACHE_KEY_DEPS }}-${{ github.run_id }}-
                      ${{ env.CACHE_KEY_PREFIX }}-${{ env.CACHE_KEY_DEPS }}-
                      ${{ env.CACHE_KEY_PREFIX }}-

            - name: install-dependencies
              run: uv sync --all-extras --all-groups --frozen

            - name: setup-path
              shell: bash
              run: |
                  if [ "$RUNNER_OS" == "Windows" ]; then
                      echo "${{ github.workspace }}/.venv/Scripts" >> $GITHUB_PATH
                  else
                      echo "${{ github.workspace }}/.venv/bin" >> $GITHUB_PATH
                  fi

            - name: run-tests
              run: bake test-rust

            - name: save-cache-cargo
              if: always()
              uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
              with:
                  path: ${{ env.CARGO_CACHE_PATHS }}
                  key: ${{ steps.restore-cache-cargo.outputs.cache-primary-key }}

            - name: upload-coverage-reports-to-codecov
              if: matrix.os == 'ubuntu-latest'
              uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
              with:
                  fail_ci_if_error: true
                  token: ${{ secrets.CODECOV_TOKEN }}
                  verbose: true

            - name: sonarqube-scan
              if: matrix.os == 'ubuntu-latest'
              uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    python:
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                python_version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
        runs-on: ${{ matrix.os }}
        steps:
            - name: checkout-repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
              with:
                  fetch-depth: 0

            - name: setup-rust-toolchain
              uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
              with:
                  toolchain: stable

            - name: restore-cache-cargo
              id: restore-cache-cargo
              env:
                  CACHE_KEY_PREFIX: cargo-${{ github.workflow }}-${{ github.job }}-${{ runner.os }}
              uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
              with:
                  path: ${{ env.CARGO_CACHE_PATHS }}
                  key: ${{ env.CACHE_KEY_PREFIX }}-${{ hashFiles('**/Cargo.lock') }}-${{ github.run_id }}-${{ github.run_attempt }}
                  restore-keys: |
                      ${{ env.CACHE_KEY_PREFIX }}-${{ hashFiles('**/Cargo.lock') }}-
                      ${{ env.CACHE_KEY_PREFIX }}-

            - name: set-python-version
              run: echo "${{ matrix.python-version }}" > .python-version

            - name: setup-mise
              uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1

            - name: cache-venv
              env:
                  CACHE_KEY_PREFIX: venv-${{ github.workflow }}-${{ github.job }}-${{ runner.os }}-py${{ matrix.python_version }}
                  CACHE_KEY_DEPS: ${{ hashFiles('uv.lock') }}
              uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
              with:
                  path: |
                      ~/.local/share/uv
                      ~/.cache/uv
                      ${{ github.workspace }}/.venv
                  key: ${{ env.CACHE_KEY_PREFIX }}-${{ env.CACHE_KEY_DEPS }}-${{ github.run_id }}-${{ github.run_attempt }}
                  restore-keys: |
                      ${{ env.CACHE_KEY_PREFIX }}-${{ env.CACHE_KEY_DEPS }}-${{ github.run_id }}-
                      ${{ env.CACHE_KEY_PREFIX }}-${{ env.CACHE_KEY_DEPS }}-
                      ${{ env.CACHE_KEY_PREFIX }}-

            - name: install-dependencies
              shell: bash
              run: |
                  uv sync --all-extras --all-groups --frozen
                  if [ "$RUNNER_OS" == "Windows" ]; then
                      echo "${{ github.workspace }}/.venv/Scripts" >> $GITHUB_PATH
                  else
                      echo "${{ github.workspace }}/.venv/bin" >> $GITHUB_PATH
                  fi
                  echo "${{ github.workspace }}/target/release" >> $GITHUB_PATH

            - name: run-tests
              run: bake test-python

            - name: save-cache-cargo
              if: always()
              uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
              with:
                  path: ${{ env.CARGO_CACHE_PATHS }}
                  key: ${{ steps.restore-cache-cargo.outputs.cache-primary-key }}
