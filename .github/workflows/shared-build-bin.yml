name: build-bin

on:
    workflow_call:
        inputs:
            version:
                description: "Version to set in Cargo.toml (e.g., '1.0.0'). If not provided, version update is skipped"
                type: string
                required: false
            tag:
                description: "Git tag for release upload (e.g., 'v1.0.0'). Only used when upload_to_release is true"
                type: string
                required: false
            upload_to_release:
                description: "Whether to upload binaries to GitHub release"
                type: boolean
                required: false
                default: false

jobs:
    build-bin:
        name: build-bin-${{ matrix.name }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - name: linux-x64
                      os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      artifact_name: zerv
                      asset_name: zerv-linux-x86_64
                    - name: linux-arm64
                      os: ubuntu-latest
                      target: aarch64-unknown-linux-gnu
                      artifact_name: zerv
                      asset_name: zerv-linux-arm64
                    - name: macos-x64
                      os: macos-latest
                      target: x86_64-apple-darwin
                      artifact_name: zerv
                      asset_name: zerv-macos-x86_64
                    - name: macos-arm64
                      os: macos-latest
                      target: aarch64-apple-darwin
                      artifact_name: zerv
                      asset_name: zerv-macos-arm64
                    - name: windows-x64
                      os: windows-latest
                      target: x86_64-pc-windows-msvc
                      artifact_name: zerv.exe
                      asset_name: zerv-windows-x86_64.exe
                    - name: windows-arm64
                      os: windows-latest
                      target: aarch64-pc-windows-msvc
                      artifact_name: zerv.exe
                      asset_name: zerv-windows-arm64.exe

        steps:
            - name: checkout-repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

            - name: setup-rust-toolchain
              uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
              with:
                  toolchain: stable

            - name: install-target
              shell: bash
              run: rustup target add ${{ matrix.target }}

            - name: install-cross-compilation-dependencies
              if: matrix.target == 'aarch64-unknown-linux-gnu'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gcc-aarch64-linux-gnu
                  echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

            - name: update-cargo-toml-version
              if: inputs.version != ''
              shell: bash
              run: |
                  VERSION="${{ inputs.version }}"
                  echo "Updating version to $VERSION"
                  if [[ "$RUNNER_OS" == "macOS" ]]; then
                      sed -i '' "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
                  else
                      sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
                  fi

            - name: build-binary
              run: cargo build --release --target ${{ matrix.target }}

            - name: upload-binary-to-release
              if: inputs.upload_to_release == true && inputs.tag != ''
              uses: svenstaro/upload-release-action@6b7fa9f267e90b50a19fef07b3596790bb941741 # 2.11.3
              with:
                  repo_token: ${{ secrets.GITHUB_TOKEN }}
                  file: target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
                  asset_name: ${{ matrix.asset_name }}
                  tag: ${{ inputs.tag }}
                  overwrite: true
